<? namespace Bitrix\Main\Security\W;$GLOBALS['____1828591616']= array(base64_decode('dGltZQ=='),base64_decode('dG'.'ltZQ=='),base64_decode('a'.'nNvbl9k'.'Z'.'WNvZGU='),base64_decode(''.'YXJy'.'Y'.'Xlf'.'b'.'WVyZ2U='),base64_decode('am9p'.'bg='.'='),base64_decode('am9p'.'bg=='),base64_decode('am9pbg=='),base64_decode('YXJy'.'YXl'.'fc'.'G'.'9w'),base64_decode('YX'.'JyYXlfc'.'2hpZ'.'nQ'.'='),base64_decode('YXJ'.'y'.'YX'.'lfc2hp'.'Zn'.'Q='),base64_decode('YXJyYXl'.'fc2hpZnQ='),base64_decode(''.'YXJy'.'YXlfc'.'2'.'hpZnQ'.'='),base64_decode(''.'YX'.'JyY'.'X'.'lf'.'bWVyZ'.'2U'.'='),base64_decode(''.'aXNfYXJyYX'.'k='),base64_decode('YXJyYXl'.'fbWVyZ2U='),base64_decode(''.'aW5fYXJy'.'YXk='),base64_decode(''.'aW5fYXJy'.'YXk'.'='),base64_decode('aW5'.'fYXJyY'.'Xk='),base64_decode(''.'aW5fYXJyYXk='),base64_decode('aW5f'.'YXJ'.'yYXk='),base64_decode('dG'.'lt'.'ZQ'.'=='),base64_decode(''.'dG'.'ltZQ=='),base64_decode('YXJy'.'YXlf'.'bWFw'),base64_decode(''.'Z2V0'.'X2xv'.'Y'.'WRlZF9leHRl'.'bnNpb25'.'z'),base64_decode('a'.'nNvbl'.'9lb'.'mNvZ'.'GU='),base64_decode('anNv'.'bl9'.'lb'.'m'.'Nv'.'ZGU'.'='),base64_decode(''.'cGhwdmVyc2lvbg=='),base64_decode('anNvbl9l'.'b'.'m'.'NvZGU'.'='),base64_decode('am9pbg=='));if(!function_exists(__NAMESPACE__.'\\___1388475561')){function ___1388475561($_801934258){static $_2052516589= false; if($_2052516589 == false) $_2052516589=array('V1dBTExfT'.'E9DS'.'w'.'='.'=','c2Vjd'.'XJpdHk=','R'.'EF'.'UQQ==',''.'eyI=','V1'.'dB'.'TExfTE9DSw='.'=','c2VjdXJpd'.'Hk=','U0V'.'DVVJ'.'JV'.'F'.'lfV1'.'dBT'.'ExfRVh'.'D'.'RVB'.'USU'.'9O',''.'RkFJT'.'F9DSEVDS0lORw'.'==','Q2F'.'uI'.'G5'.'vd'.'C'.'Ble'.'G'.'Vjd'.'XRlIHd'.'3Y'.'WxsIHJ1bGVz'.'O'.'i'.'A=','IF'.'Ry'.'YWNlOiA=',''.'UkVR'.'V'.'U'.'VTVF9'.'VUkk=','a2V5cw==','dmFsdW'.'Vz',''.'U0VDVV'.'JJVFlfV1dB'.'TExfTU9ESUZZ','Lg==','U0V'.'DVVJJV'.'FlfV1dBTExfVU5TRVQ=','L'.'g='.'=','U0V'.'D'.'VVJJ'.'VFlfV1dBTE'.'xfR'.'VhJVA'.'==','Lg'.'==','Z2xvYmFs','a2V5cw'.'==',''.'dmFsdWVz','Z2V'.'0','Z2'.'V0','cG'.'9zdA==','cG9'.'zdA==','Y29va2ll','Y29v'.'a2ll','cmVxdWVzd'.'A==','cm'.'V'.'xdWVzdA==','Z'.'2'.'xvY'.'mF'.'s','Z'.'2'.'xvYm'.'Fs','b'.'WFpbl9'.'zZWM=','V1dBT'.'ExfQUNUVUF'.'MSV'.'pF'.'X'.'1JVTEVT',''.'dg==','dmVyc2lvb'.'g==','aQ'.'='.'=','aXNJb'.'n'.'N0YWxsZWQ=',''.'dg==','a'.'W5p','bW9'.'kd'.'Wx'.'l'.'cw'.'==','b'.'GljZW5zZQ='.'=','c'.'Ghw','dg='.'=',''.'ZXh0','c2'.'Vjd'.'X'.'J'.'p'.'dHk=','ZGI=','d'.'HlwZQ==','ZGI'.'=','dmVyc'.'2lvbg==',''.'ZGI=',''.'dHlwZQ='.'=','ZG'.'I=',''.'dHl'.'wZQ==',''.'dmVy'.'c2lvbg==','ZGI'.'=','dmV'.'yc'.'2lvbg'.'==','ZW52aXJvbm1lbnQ=','d'.'m1fdmVyc2l'.'vbg==','d'.'m'.'0=',''.'dg==',''.'ZW52aXJ'.'v'.'bm1l'.'bnQ=','dm1'.'fd'.'mV'.'yc2'.'lvbg='.'=','c29j'.'a2V'.'0'.'VGltZW91dA='.'=','c3RyZWFtVGltZW91dA==','KCc=',''.'ZGF0'.'Y'.'Q==','Jy'.'w'.'gJw'.'==',''.'b'.'W9kd'.'Wxl','Jy'.'wgJ'.'w==','bW9kd'.'WxlX3Zl'.'cnN'.'pb24=',''.'J'.'yk=','LC'.'A=','U0VDV'.'VJ'.'JVFlfV1dBTExfRV'.'hDRVBUSU9O','bWFpbg==','R'.'kFJTF9SRU'.'ZSR'.'VN'.'ISU5H','Q2Fu'.'I'.'G5vd'.'CByZ'.'W'.'ZyZXNoIH'.'d3YWxsI'.'HJ1bGVzO'.'iA=','IF'.'R'.'yY'.'WN'.'lOiA=','ZGF0YQ==','eyI'.'=','LS0tLS1'.'CRU'.'dJTi'.'BQVUJMSU'.'M'.'gS'.'0VZLS0tLS0=','Ck'.'1JSUJJ'.'ak'.'FOQm'.'d'.'rcWh'.'raUc'.'5'.'d'.'zBCQVF'.'FRkFB'.'T'.'0NBUThBTUlJQkN'.'n'.'S0'.'NB'.'U'.'UVBcThRRTB'.'Ia'.'m1ISlVTdFd'.'WNm4w'.'emE'.'KUlZvTHg'.'wMkt'.'6YmZyY'.'lMvUDZzV2F'.'4'.'V'.'Hp3OFNlR1R0Y'.'lRDT'.'3J'.'w'.'SGk1'.'U'.'U'.'Y2T1J'.'5a'.'l'.'o'.'vWHh6L'.'0tMVT'.'FHYm9mOUNaMw'.'o'.'0'.'ejdT'.'a3FVdD'.'Y2a'.'WJYdk9GQ'.'ng0Z'.'nc'.'vQ'.'VBQUkdEcXR'.'t'.'MG'.'5E'.'M2ZnR'.'3N1M1JlUGd3M'.'jlpOCt'.'2b'.'TdtdEJL'.'SlVZbDRy'.'ClZwYjZzZl'.'pF'.'VDlLRW'.'I2VDFIRF'.'lt'.'RX'.'Z'.'jMW'.'h'.'xL2'.'lpdXl4THJaWmk'.'1'.'UTZV'.'ZmY0VU'.'V2VE'.'krNj'.'hzc0ZSa'.'1Erb3d'.'UUnkKZU9JTWJ'.'GaE0vVVRtZlZ'.'ZY'.'l'.'RSRnkyb1VROFdNe'.'mEybk'.'o1U2Foemk'.'xVU'.'tPMWpBa'.'lh'.'UUFJyemM3'.'QWp'.'1Nj'.'M5ajFPMA'.'pwcHFmb'.'T'.'V'.'4Z1dsRkFKa0'.'hRV'.'Gdi'.'ZGQ1QVdxREZ'.'Ra'.'3Q5SEtrWStUb'.'mZCTEdWTXZ'.'WeV'.'B3VEhOV'.'1FZQXc0'.'eH'.'BnL3dBClp3'.'SUR'.'BUUFC'.'C'.'i0tLS0'.'tRU5EIFBV'.'QkxJQ'.'y'.'BLRVktL'.'S'.'0tLQ==');return base64_decode($_2052516589[$_801934258]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use Bitrix\Main\License\UrlProvider; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; protected $_163414146= true; public function handle(){ try{  $_1239092007= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_1239092007)){ return;}  $_2072659134= Cache::createInstance(); $_1393580406= false; if($_2072659134->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1831994623= $_2072659134->getVars(); if($GLOBALS['____1828591616'][0]()- $_1831994623> round(0+5+5+5+5)){  $_47118564= Application::getConnection(); $_786690669= RuleRecordTable::getTableName(); $_47118564->truncateTable($_786690669); RuleRecordTable::cleanCache(); $_2072659134->clean(___1388475561(0), ___1388475561(1));}} elseif($_2072659134->startDataCache()){  $_2072659134->endDataCache($GLOBALS['____1828591616'][1]()); $_1393580406= true;} foreach($_1239092007 as $_1270844719){ $_1917752242= new PublicKeyCipher; $_1647698010= $_1917752242->decrypt($_1270844719[___1388475561(2)], static::__576209940()); if(!str_starts_with($_1647698010, ___1388475561(3))){ continue;} $_1776457810= $GLOBALS['____1828591616'][2]($_1647698010, true); if(!empty($_1776457810)){ $_645344726= Rule::make($_1776457810); $_1022599768= $this->handleRule($_645344726); $this->applyHandlingResults($_1022599768);}}  if($_1393580406){ $_2072659134->clean(___1388475561(4), ___1388475561(5));}} catch(\Throwable $_2138912430){ $this->logEvent( ___1388475561(6), ___1388475561(7), ___1388475561(8). $_2138912430->getMessage(). ___1388475561(9). $_2138912430->getTraceAsString());}}  public function handleRule(Rule $_645344726): array{ $_1022599768=[]; if($_645344726->matchPath($_SERVER[___1388475561(10)])){  $_167413873= $this->getContextElements($_645344726->getContext()); foreach($_167413873 as $_131626288 => &$_1140909074){ $_1022599768= $GLOBALS['____1828591616'][3]($_1022599768, $this->recursiveContextKeyHandle($_131626288, $_1140909074,[], $_645344726));}} return $_1022599768;}  public function applyHandlingResults(array $_1022599768){ $_167413873= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1022599768 as $_363096662){ $_1140909074=& $_167413873[$_363096662->getContextName()]; $_603489047= $_363096662->getRuleResult(); $_645344726= $_363096662->getRule(); if($_603489047 instanceof ModifyResult){ if($_645344726->getProcess() === ___1388475561(11)){  static::rewriteContextKey( $_363096662->getContextName(), $_1140909074, $_363096662->getContextKey(), $_603489047->getCleanValue());} elseif($_645344726->getProcess() === ___1388475561(12)){ static::rewriteContextValue( $_363096662->getContextName(), $_1140909074, $_363096662->getContextKey(), $_603489047->getCleanValue());} $this->logEvent( ___1388475561(13), $_363096662->getContextName(), $GLOBALS['____1828591616'][4](___1388475561(14), $_363096662->getContextKey()));} elseif($_603489047 instanceof CheckResult &&!$_603489047->isSuccess()){ if($_603489047->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_363096662->getContextName(), $_1140909074, $_363096662->getContextKey(),); $this->logEvent( ___1388475561(15), $_363096662->getContextName(), $GLOBALS['____1828591616'][5](___1388475561(16), $_363096662->getContextKey()));} elseif($_603489047->getAction() === RuleAction::EXIT){ $this->logEvent( ___1388475561(17), $_363096662->getContextName(), $GLOBALS['____1828591616'][6](___1388475561(18), $_363096662->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_163414146= false;} protected function rewriteContextKey($_131626288, &$_1140909074, $_1718516443, $_2066172358){ $_1380272384= $_1718516443;  $GLOBALS['____1828591616'][7]($_1380272384); $_1380272384[]= $_2066172358; if($_131626288 === ___1388475561(19)){ $_1544840085= $GLOBALS['____1828591616'][8]($_1718516443); $GLOBALS['____1828591616'][9]($_1380272384); if(empty($_1718516443)){ $GLOBALS[$_2066172358]= $GLOBALS[$_1544840085]; unset($GLOBALS[$_1544840085]);} else{ $_1140909074=& $GLOBALS[$_1544840085]; $_2091385291= ArrayHelper::getByNestedKey($_1140909074, $_1718516443);  ArrayHelper::setByNestedKey($_1140909074, $_1380272384, $_2091385291);  ArrayHelper::unsetByNestedKey($_1140909074, $_1718516443);}} else{ $_2091385291= ArrayHelper::getByNestedKey($_1140909074, $_1718516443);  ArrayHelper::setByNestedKey($_1140909074, $_1380272384, $_2091385291);  ArrayHelper::unsetByNestedKey($_1140909074, $_1718516443);}} protected function rewriteContextValue($_131626288, &$_1140909074, $_924124943, $_2091385291){ if($_131626288 === 'global'){ $_1544840085= $GLOBALS['____1828591616'][10]($_924124943); if(empty($_924124943)){ $GLOBALS[$_1544840085]= $_2091385291;} else{ $_1140909074=& $GLOBALS[$_1544840085]; ArrayHelper::setByNestedKey($_1140909074, $_924124943, $_2091385291);}} else{  ArrayHelper::setByNestedKey($_1140909074, $_924124943, $_2091385291);}} protected function unsetContextValue($_131626288, &$_1140909074, $_924124943){ if($_131626288 === 'global'){ $_1544840085= $GLOBALS['____1828591616'][11]($_924124943); if(empty($_924124943)){ unset($GLOBALS[$_1544840085]);} else{ $_1140909074=& $GLOBALS[$_1544840085]; ArrayHelper::unsetByNestedKey($_1140909074, $_924124943);}} else{ ArrayHelper::unsetByNestedKey($_1140909074, $_924124943);}}  protected function recursiveContextKeyHandle(string $_131626288, array &$_1140909074, array $_244532245, Rule $_645344726): array{  $_1022599768=[]; foreach($_1140909074 as $_876036327 => $_2091385291){ $_924124943= $GLOBALS['____1828591616'][12]($_244532245,[$_876036327]); if($_645344726->matchKey($_924124943)){  if($_645344726->getProcess() === ___1388475561(20)){ $_603489047= $_645344726->evaluate($_876036327);} elseif($_645344726->getProcess() === ___1388475561(21)){ $_603489047= $_645344726->evaluateValue($_2091385291);}  if(!empty($_603489047) && $_603489047 instanceof RuleResult){ $_1022599768[]= new HandlingResult($_131626288, $_924124943, $_603489047, $_645344726);}}  if($GLOBALS['____1828591616'][13]($_2091385291)){ $_1022599768= $GLOBALS['____1828591616'][14]($_1022599768, $this->recursiveContextKeyHandle( $_131626288, $_1140909074[$_876036327], $_924124943, $_645344726));}} return $_1022599768;} protected function getContextElements(array $_1821166301){ $_822423429=[]; if($GLOBALS['____1828591616'][15](___1388475561(22), $_1821166301, true)){ $_822423429[___1388475561(23)]= &$_GET;} if($GLOBALS['____1828591616'][16](___1388475561(24), $_1821166301, true)){ $_822423429[___1388475561(25)]= &$_POST;} if($GLOBALS['____1828591616'][17](___1388475561(26), $_1821166301, true)){ $_822423429[___1388475561(27)]= &$_COOKIE;} if($GLOBALS['____1828591616'][18](___1388475561(28), $_1821166301, true)){ $_822423429[___1388475561(29)]= &$_REQUEST;} if($GLOBALS['____1828591616'][19](___1388475561(30), $_1821166301, true)){ $_822423429[___1388475561(31)]= $GLOBALS;} return $_822423429;} public static function refreshRules(){ try{ $_2098393972= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1828591616'][20]()- $_2098393972)< static::CACHE_RULES_TTL){ return;} Option::set(___1388475561(32), ___1388475561(33), $GLOBALS['____1828591616'][21]()); $_290639791= null;  $_1204116728= $GLOBALS['____1828591616'][22](function($_2144281387){ return[___1388475561(34) => $_2144281387[___1388475561(35)], ___1388475561(36) => (int) $_2144281387[___1388475561(37)]];}, ModuleManager::getModulesFromDisk());  $_1913110947=[]; foreach($GLOBALS['____1828591616'][23]() as $_760933404){ $_1861532726= new ReflectionExtension($_760933404); $_1913110947[$_760933404]=[ ___1388475561(38) => $_1861532726->getVersion(), ___1388475561(39) => $_1861532726->getINIEntries()];} $_203616893=[ ___1388475561(40) => $GLOBALS['____1828591616'][24]($_1204116728), ___1388475561(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1388475561(42) => $GLOBALS['____1828591616'][25]([ ___1388475561(43) => $GLOBALS['____1828591616'][26](), ___1388475561(44) => $_1913110947])]; if(Loader::includeModule(___1388475561(45))){ $_1114404056= CSecuritySystemInformation::getSystemInformation(); if(isset($_1114404056[___1388475561(46)][___1388475561(47)]) && isset($_1114404056[___1388475561(48)][___1388475561(49)])){ $_203616893[___1388475561(50)]=[ ___1388475561(51) => $_1114404056[___1388475561(52)][___1388475561(53)], ___1388475561(54) => $_1114404056[___1388475561(55)][___1388475561(56)]];} if(isset($_1114404056[___1388475561(57)][___1388475561(58)])){ $_203616893[___1388475561(59)]=[___1388475561(60) => $_1114404056[___1388475561(61)][___1388475561(62)]];}}  $_641710372= new HttpClient([ ___1388475561(63) => round(0+1.25+1.25+1.25+1.25), ___1388475561(64) => round(0+5)]); $_213166689=(new UrlProvider())->getTechDomain(); $_1534381383="https://wwall.{$_213166689}/rules.php"; $_2109995613= $_641710372->post($_1534381383, $_203616893); if($_641710372->getStatus() == round(0+200) &&!empty($_2109995613)){ $_290639791= Json::decode($_2109995613);}  if($_290639791 !== null){ $_47118564= Application::getConnection(); $_786690669= RuleRecordTable::getTableName(); if(!empty($_290639791)){ foreach($_290639791 as $_1597455611){ if(!static::checkRuleSign($_1597455611)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1828591616'][27]($_1597455611));}}}  $_47118564->truncateTable($_786690669);  if(!empty($_290639791)){ $_1513195123=[]; foreach($_290639791 as $_1597455611){ $_1513195123[]= ___1388475561(65). $_47118564->getSqlHelper()->forSql($_1597455611[___1388475561(66)]). ___1388475561(67). $_47118564->getSqlHelper()->forSql($_1597455611[___1388475561(68)]). ___1388475561(69). $_47118564->getSqlHelper()->forSql($_1597455611[___1388475561(70)]). ___1388475561(71);} $_1416747493= $GLOBALS['____1828591616'][28](___1388475561(72), $_1513195123);  $_47118564->query("INSERT INTO {$_786690669} (DATA, MODULE, MODULE_VERSION) VALUES {$_1416747493}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_2138912430){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1388475561(73), ___1388475561(74), ___1388475561(75), ___1388475561(76). $_2138912430->getMessage(). ___1388475561(77). $_2138912430->getTraceAsString());}} protected static function checkRuleSign($_645344726){ $_1917752242= new PublicKeyCipher; $_1776457810= $_1917752242->decrypt($_645344726[___1388475561(78)], static::__576209940()); return str_starts_with($_1776457810, ___1388475561(79));} private static function __576209940(){ $_1537856628= ''; $_1537856628 .= ___1388475561(80); $_1537856628 .= ___1388475561(81); return $_1537856628;} protected function logEvent($_1551353365, $_1380931334, $_215349098){ if($this->_163414146){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1551353365, 'main', $_1380931334, $_215349098);}}}?>